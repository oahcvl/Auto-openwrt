#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
# 
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#

name: å¯é€‰æ‹©è‡ªç¼–è¯‘å›ºä»¶

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "æœºå‹é€‰æ‹©"
        required: false
        default: "Lede_x86_64"
        type: choice
        options:
          - Lede_x86_64
          - Lienol_x86_64
          - Project_x86_64
          - Lede_redmi_ac2100
          - Lede_newifi_d2
          - Project_newifi_d2
          - Lede_phicomm_k2p
          - Lienol_phicomm_k2p
          - Lienol_phicomm_k3
          - Project_phicomm_k3

#ç¼–è¾‘ä»»æ„æŒ‡å®šæ–‡ä»¶è§¦å‘å¼€å§‹ç¼–è¯‘
#  push:
#    branches:
#      - master
#    paths:
#      - 'å¼€å¯ç¼–è¯‘openwrt'

#å®šæ—¶è§¦å‘å¼€å§‹ç¼–è¯‘(å¼€å¯å®šæ—¶ç¼–è¯‘è¯·å…ˆç¡®å®šSSHå¤„åœ¨å…³é—­çŠ¶æ€,è¦ä¸ç„¶SSHæ²¡äººç®¡,ä¼šå¡SSHç¼–è¯‘å¤±è´¥)
#  schedule:
#    - cron: 0 8 */5 * *

#ç‚¹â˜†Starè§¦å‘å¼€å§‹ç¼–è¯‘
# watch:
#    types: started

env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  GITHUB_RELEASE: ""
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: ["${{ inputs.source_branch }}"]
    steps:
      - name: æ£€æµ‹è„šæœ¬è®¾ç½®
        run: |
          source "${GITHUB_WORKSPACE}/build/${{ matrix.target }}/settings.ini"
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
          echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV
          echo "WXFB_MESSAGE=$WXFB_MESSAGE" >> $GITHUB_ENV
          echo "DIY_P1_SH=$DIY_P1_SH" >> $GITHUB_ENV
          echo "DIY_P2_SH=$DIY_P2_SH" >> $GITHUB_ENV
          echo "SSH_ACTIONS=$SSH_ACTIONS" >> $GITHUB_ENV
          echo "UPLOAD_BIN_DIR=$UPLOAD_BIN_DIR" >> $GITHUB_ENV
          echo "UPLOAD_CONFIG=$UPLOAD_CONFIG" >> $GITHUB_ENV
          echo "UPLOAD_FIRMWARE=$UPLOAD_FIRMWARE" >> $GITHUB_ENV
          echo "UPLOAD_COWTRANSFER=$UPLOAD_COWTRANSFER" >> $GITHUB_ENV
          echo "UPLOAD_RELEASE=$UPLOAD_RELEASE" >> $GITHUB_ENV
          echo "SERVERCHAN_SCKEY=$SERVERCHAN_SCKEY" >> $GITHUB_ENV
  
      - name: å¾®ä¿¡é€šçŸ¥
        if: env.SERVERCHAN_SCKEY == 'true'
        uses: emon100/Action-Serverchan@master
        with:
          SCKEY: ${{ secrets.SCKEY }}
          text: å¼€å§‹ç¼–è¯‘${{ matrix.target }}å•¦
          desp: ä¸»äººæ‚¨è®¾ç½®è¦ç¼–è¯‘çš„[${{ env.WXFB_MESSAGE }}]å›ºä»¶æ­£åœ¨åŠªåŠ›è€•è€˜ä¸­......
      
      - name: å¼€å§‹å®‰è£…ç¼–è¯‘æ‰€éœ€ç³»ç»Ÿ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
      
      - name: å…‹éš†æºç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
  
      - name: åŠ è½½æº, åº”ç”¨è¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
        run: |
          cp -Rf $(find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './') openwrt
          cd openwrt
          echo "åº”ç”¨è¡¥ä¸"
          if [ -n "$(ls -A "build/${{matrix.target}}/patches" 2>/dev/null)" ]; then
            (
              find "build/${{matrix.target}}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%' | patch -d './' -p0 --forward" || true
            )
          fi
          if [ -f "build/${{matrix.target}}/$DIY_P1_SH" ]; then
            (
              chmod +x "build/${{matrix.target}}/$DIY_P1_SH"
              /bin/bash "build/${{matrix.target}}/$DIY_P1_SH"
            )
          fi
          ./scripts/feeds clean
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          if [ -n "$(ls -A "build/${{matrix.target}}/files" 2>/dev/null)" ]; then
            cp -rf "build/${{matrix.target}}/files" files
          fi
          if [ -n "$(ls -A "build/${{matrix.target}}/diy" 2>/dev/null)" ]; then
            cp -Rf "build/${{matrix.target}}/diy"/* ./
          fi
          if [ -f "build/${{matrix.target}}/$DIY_P2_SH" ]; then
            (
              chmod +x "build/${{matrix.target}}/$DIY_P2_SH"
              /bin/bash "build/${{matrix.target}}/$DIY_P2_SH"
            )
          fi
          mv "build/${{matrix.target}}/$CONFIG_FILE" .config
          make defconfig
          DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '[:upper:]' '[:lower:]')
          if [ "$DEVICE_NAME" == "generic" ]; then
            DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/CONFIG_TARGET_(.*)_DEVICE_.*=y/\1/')
          fi
          DEVICE_NAME=${DEVICE_NAME/xiaomi_redmi-router/redmi}
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
  
      - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨é…ç½®å›ºä»¶
        uses: P3TERX/ssh2actions@main
        if: env.SSH_ACTIONS == 'true' || contains(github.event.action, 'ssh')
      
      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
      
      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "date=$(date "+%Y-%m-%d %H.%M")" >> $GITHUB_ENV
          echo "date1=$(date +'%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†')" >> $GITHUB_ENV
          echo "date2=$(date +'%Y%m%d-%H%M')" >> $GITHUB_ENV
  
      - name: ä¸Šä¼ binæ–‡ä»¶å¤¹ï¼ˆå›ºä»¶+ipkï¼‰åˆ°GitHubç©ºé—´
        uses: actions/upload-artifact@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: "OpenWrt_bin_${{ matrix.target }}_${{ env.date }}"
          path: openwrt/bin

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        id: organizer
        run: |
          # åˆ›å»ºconfigæ–‡ä»¶å¤¹
          mkdir -p config
          # å°†openwrt/bin/targets/ä¸‹çš„æ‰€æœ‰*config.buildinfo*æ–‡ä»¶ç§»åŠ¨åˆ°configæ–‡ä»¶å¤¹
          find openwrt/bin/targets/ -name "*config.buildinfo*" -exec mv -f {} config/ \;
          # è¿›å…¥openwrt/bin/targets/ä¸‹çš„ç¬¬ä¸€ä¸ªå­ç›®å½•
          cd "$(ls -d openwrt/bin/targets/*/ | head -n 1)"
          # åˆ é™¤å¹¶é‡æ–°åˆ›å»ºpackagesæ–‡ä»¶å¤¹
          rm -rf packages && mkdir packages
          # å°†ç‰¹å®šç±»å‹çš„æ–‡ä»¶ç§»åŠ¨åˆ°packagesæ–‡ä»¶å¤¹
          find . -name "*.buildinfo*" -exec mv -f {} packages/ \;
          find . -name "*sha256sums*" -exec mv -f {} packages/ \;
          find . -name "*kernel.bin*" -exec mv -f {} packages/ \;
          find . -name "*kernel1.bin*" -exec mv -f {} packages/ \;
          find . -name "*rootfs*" -exec mv -f {} packages/ \;
          find . -name "*.manifest*" -exec mv -f {} packages/ \;
          find . -name "*vmlinuz*" -exec mv -f {} packages/ \;
          find . -name "*esxi.vmdk*" -exec mv -f {} packages/ \;
          # å†æ¬¡åˆ é™¤packagesæ–‡ä»¶å¤¹ï¼ˆæ­¤æ­¥éª¤å¯èƒ½æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºä¸Šé¢å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼‰
          # rm -rf packages  # å¦‚æœä¸éœ€è¦å†æ¬¡åˆ é™¤ï¼Œå¯ä»¥æ³¨é‡Šæˆ–åˆ é™¤æ­¤è¡Œ
          # å°†FIRMWAREç¯å¢ƒå˜é‡è®¾ç½®ä¸ºå½“å‰å·¥ä½œç›®å½•ï¼Œå¹¶è¾“å‡ºåˆ°$GITHUB_ENVæ–‡ä»¶
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          # å‘$GITHUB_OUTPUTè¾“å‡ºçŠ¶æ€ä¿¡æ¯
          echo "status=success" >> $GITHUB_OUTPUT
          
      - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶åˆ°GitHubç©ºé—´
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true'
        uses: actions/upload-artifact@v2
        with:
          name: .config_${{matrix.target}}_${{ env.date }}
          path: ./config
      
      - name: ä¸Šä¼ å›ºä»¶åˆ°GitHubç©ºé—´
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        uses: actions/upload-artifact@v2
        with:
          name: OpenWrt_firmware_${{matrix.target}}_${{ env.date }}
          path: ${{ env.FIRMWARE }}
      
      - name: ä¸Šä¼ å›ºä»¶åˆ°ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€ŒWeTransferã€
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL https://git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          curl -fsSL https://git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
          
      - name: æå–å‘å¸ƒç”¨çš„ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€ŒWeTransferã€çš„é“¾æ¥
        if: steps.organizer.outputs.status == 'success' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "COWTRANSFER_URL=$(cat cowtransfer.log | grep \"https\" | cut -f3 -d\")\" >> $GITHUB_ENV
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "WETRANSFER_URL=$(cat wetransfer.log | grep https | cut -f3 -d\")\" >> $GITHUB_ENV
  
      - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@v1
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          name: ${{ env.date1 }} ã€Œ ${{ env.WXFB_MESSAGE }} ã€å›ºä»¶
          tag_name: ${{ env.date2 }}
          body: |
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
      
            ğŸ‰ [ ${{ matrix.target }} ]å›ºä»¶ä¸‹è½½ âœ¨
      
            ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_URL }}
      
            â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_URL }}
      
            ğŸŒ´ é“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©ï¼Œæ— éœ€æ³¨å†Œç›´æ¥ä¸‹è½½ ğŸ¤
          æ–‡ä»¶: ${{ env.FIRMWARE }}/*
  
      - name: å¾®ä¿¡é€šçŸ¥
        if: steps.organizer.outputs.status == 'success' && env.SERVERCHAN_SCKEY == 'true'
        uses: emon100/Action-Serverchan@master
        with:
          SCKEY: ${{ secrets.SCKEY }}
          text: |-
            æ­å–œä¸»äºº${{ matrix.target }}å›ºä»¶ç¼–è¯‘æˆåŠŸï¼
            
            å®Œæˆæ—¶é—´ï¼š${{ env.date1 }}
            
            å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}
            
            å¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}
            
            WeTransferï¼š${{ env.WETRANSFER_URL }}
          desp: |-
            æˆ‘äº²çˆ±çš„ä¸»äººæ‚¨è¦ç¼–è¯‘çš„${{ env.WXFB_MESSAGE }}å›ºä»¶æˆåŠŸå®Œæˆäº†ï¼
            
            ç¥å°ä¸»äººè§äººçˆ±ï¼ŒèŠ±è§èŠ±å¼€ï¼Œè½¦è§è½¦è½½ï¼Œå¤©å¤©å¥½å¿ƒæƒ…ğŸˆï¼ï¼ï¼
  
